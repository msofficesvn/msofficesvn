Word 97のツールバーの前回の位置を記憶させて、Word起動時にそこに表示させられないか。

 * AutoExec()中でコマンドバーを削除しているコードをコメントアウトしても効果がなかった。
 * ExceのようなアプリケーションオブジェクトのインストールイベントはWordにはないのか? -> なさそう。
 * iniファイルに前回の位置(Position, Top, Left)を記録して、メニューインストール時に設定してみたが、以下の問題があった。
    # 既存のツールバーにはくっつかないで、新たなツールバー領域を作ってしまう。
    # デュアルモニタの場合、アプリをセコンドモニタへ表示して、ツールバーをFloating(デスクトップの左上端が原点となるようだが)にして、位置を記録しても、次回のアプリ起動時に、pptは常にプライマリモニタにソフト本体が表示されるので、ソフトとツールバーの位置が泣き分かれになってしまう。
 * ツールバーは、最初の一回だけインストールしたら、あとは削除しないようにしておけばよいのでは？インストールしたかどうかはiniファイルにでも記録しておく。アンインストールしたいときには、ツール／ユーザー設定画面で削除してもらう。(メニューバーに関しては、UIからはリセットしかできず、他のアドインやユーザーカスタマイズなどへの影響があるので、今までどおりアドインをアンロードするときにメニューを削除しておく方が良いだろう)
 * Word 2007は、メニューもツールバーもリボンの中に強制的に表示される。ツールバーをフローティングにはできないようだ。(一々アドインメニューを選択しないとコマンドが実行できないので、面倒)
 * Word 2003であれば、Word終了時にツールバーを削除して、起動時にインストールするようなコードでも前回位置をちゃんと覚えていてくれるようだ。どのバージョンからそうなっているのか? 少なくともWord 97では覚えてくれない。->Wordのバージョンによらず、ツールバーのインストールは最初のアドインロード時のみとし、アンロード時には削除しない仕様にしよう。細かく場合わけをして対応しても、メンテナンスコストがかかるわりに、大してメリットがなさそうなので。


Wordのアドイン中のSVNマクロに割り付けたショートカットキーは、一度アドインをアンインストールして、再度インストールすると、画面上はキーアサインされているように見えるが、実際には実行されない。いったんキーアサインを削除して、再登録すると実行されるようになる。

 * アドインプログラム中でショートカットキーもアサインできないか?
 * Wordはショートカットキーを使う場合が少なそうだが、Excelは多そう。不用意にショートカットキーを割り付けると、ユーザーが意図しない動作をさせてしまうことになる。Excelのデフォルトショートカットキー割当を要調査。

オブジェクトを生成する場所

 * 異なる文書やブックに対して、メソッドが並行して呼ばれるので、ActiveContentクラスは、メソッドローカルで生成、破棄すること。
 * Contentsクラスはモジュール変数で良いだろう。
 * FileSystemObjectはモジュール変数にしても大丈夫かな?
 * WScript.Shellはどうだろう?

MSOfficeのメモリ消費

 * Office97で、ExcelやWordで開いているファイルを閉じてもタスクマネージャで表示されるメモリ使用量がほどんど減らないことに気づいた。

   最小化すると減る。

-> Windowsアプリはだいたいそういうものらしい。

http://support.microsoft.com/?scid=kb%3Ben-us%3B293215&x=9&y=10

ファイル保存、オープン

 * ActiveWorkbook.Save でファイルがRead Onlyで上書きしてもエラーとならない。もちろん上書きはできていない。
  ->On Error Resume Nextのせいらしい。

 * ActiveWorkbook.Saveで、保存に問題があれば、それ以降の動作を中止する旨のメッセージを表示するべき。

 * そもそも読み取りのみ可のファイルで変更がある場合、どのように処理するべきか。
   + TSVNコマンドの実行を禁止する
     ファイルを開くと内容が変更されるファイルに対してコマンドが実行できなくなってしまう。
   + ユーザに、変更内容を破棄してコマンドを実行するか、コマンド実行をしないかを選択させる。

 * Wordのバージョンチェックのやり方は要検討。数値に変換して比較できるようにしたいが、数値しか入っていないという保証はない。Word97SR2では"8.0b"というバージョンが得られる。-> Val関数で数値に変換した。

PowerPoint 97

 * PowerPointには、Excel,Wordのような、データファイルを作成するとデフォルトで生成される、ThisWorkbookクラスやThisDocumentクラスに相当するものは無いようである。アドインのインストール／アンインストールも標準モジュールを作成して、Auto_Open, Auto_Closeサブルーチンを追加するだけ。とりあえず、分かりやすいようにアドインをインストール／アンインストールする標準モジュール名をThisPresentationとした。

 * Presentation.Name はタイトルバーに表示される名前を返してくるようである。このタイトルバーに表示される名前は、ファイルの開き方(メニューから、ドラッグ＆ドロップで、エクスプローラ上でファイルをダブルクリックで、等）でなぜか拡張子が付いたり、付かなかったりする。したがって、Presentation.Nameを使ってファイルの有無をチェックするのは避けるべき。Excel,Wordではこのようなことはなさそう。

Office 2003 でver.1.0.0をテスト

 * Wordのコマンドバーからリポジトリブラウザを起動できない。「セキュリティで禁止されているか、マクロがない」旨のメッセージが表示されるのみ。メニューからは実行できるのに。セキュリティ設定を低くしてもだめ。
 * -> 以下の変更をやってみたら、直った。どちらが効いたのかは不明。
  # CommandBarButtonをツールバーへaddするときの返値を、1つの変数を使いまわして格納するのではなく、それぞれに変数を定義して格納するようにした。
  # Withのネストをやめた。

 * PowerPointはppaファイルをExcel同様AddInsフォルダに入れてみたが、アドイン追加ができない。これはセキュリティ設定を低にして、いったんアドイン追加をした後セキュリティを元の中に戻せばできた。->もっと適切なアドイン置き場所があるのか?

cf.

http://support.microsoft.com/kb/820704/ja


Word 97でアプリケーションエラー

 * Word 97でVBAコードを変更してdotファイルを作成してアドインとして登録すると、なぜかword終了時にアプリケーションエラーが発生するようになってしまった。これは、VBAコードをいったんエクスポートしたものを、wordファイルを新規作成してインポートし、wordsvn.dotを作り直したら直った。

アドインと同じメソッドが入っているファイルを開いた場合は、どちらのコードが実行される?

アンインストール時には、ツール／アドインメニューで、チェックボックスをクリアするのは必須?

 * ちゃんとアンインストールしないと、更新されなかったり、コード実行のエラーの原因となりそうな気がする。

Wordでテキストファイルを開いたときTortoiseMergeでDiffを取ろうとすると、「プロセスはファイルにアクセスできません。別のプロセスが使用中です。」とメッセージが表示され、Diffを見ることはできない。Winmergeであれば、問題なく見れる。

add-inのパス

http://209.85.175.104/search?q=cache:s6Zt51u-GzsJ:www2.moug.net/bbs/exvba/20070919000008.htm+PowerPoint+%E3%82%A2%E3%83%89%E3%82%A4%E3%83%B3+%E3%83%91%E3%82%B9&hl=ja&ct=clnk&cd=11&gl=jp&lr=lang_ja&client=firefox

VBAコードのエクスポート

http://support.microsoft.com/?scid=kb%3Ben-us%3B280157&x=7&y=15

 * Excel起動時にadd-in中の関数を自動実行させる方法

 # 標準モジュールに Auto_Open を実装する。(ただし、ThisWorkbookモジュールに実装すると実行されないので注意)
 # ThisWorkbookに Workbook_Open を実装する

    Auto_OpenとWorkbook_Openの違いについて
    http://park11.wakwak.com/~miko/Excel_Note/14-02_macro.htm#14-02-26

 * In place編集のチェック必要?

Workbook.IsInplace プロパティを使って、In place編集であるかどうかの判断をする必要があるか?

 * 参照設定が必要なライブラリ

VBEのツール/参照設定メニューでデフォルト状態から追加しなければならないライブラリ。
設定後、add-inファイルを保存すると、設定が保存される。

 - Microsoft ActiveX Data Objects 2.5 Library

これが無いと、ADODB.Streamの.Type = adTypeTextで「コンパイルエラー:変数が定義されていません。」エラーが発生する。

 - Microsoft Visual Basic for Applications Extensibility 5.3

  VBComponentで「コンパイルエラー：ユーザ定義型は定義されていません」

 * なぜかwordのアドインのスクリプトファイルのエクスポートができない。

 * なぜかwordのアドインのスクリプトファイルを最初にインポートするときに、アプリケーションエラーが発生。再度試してみるとインポートされた。再現性は不明。

 * AddしてCommitしていない状態のファイルは、Addされていることをentriesファイルでしか判別することができない。したがって、text-baseファイルの有無で管理対象かどうか判定しているルーチンを通せていない。

 →いや、そもそも通す必要はあまり無いのかも。コミット時にファイルの閉じ開きをするのは、Commit済みのファイルだけで良いはず。


ExcelでApplication.OnKeyでショートカットキーで、TSVNコマンドサブルーチンを実行できるようにした。しかし、ショートカットキーでTSVNコマンドを実行するとグローバル変数がリセットされてしまい、Excel起動時に読み出したiniファイルの内容が失われてしまう。困った。
ツールバーやメニューからTSVNコマンドを実行する場合は、グローバル変数がリセットされるようなことはないようである。

→別のショートカットキー割り当て方法を試してみたらどうか。
[エクセル] ショートカットキーの割り当てを変更する
http://arrow3.way-nifty.com/shige/2005/07/__fa5b.html

DLL 関数から文字列を返す

http://msdn.microsoft.com/ja-jp/library/cc376816.aspx

Wordのアドインdotファイルを作成するときに、VBEでプロジェクトのコンパイルを実行してからdotファイルに保存しないと、アドインロード時のショートカットキー割り当てでエラーが発生し、ショートカットキー割り当てできなくなる。
→Word2007で、dotファイルを開いてコンパイル後保存しても「指定したキーの機能を変更できません」エラーが出る。
アドインとして開いた状態でコンパイルして保存するとエラーが解消された。

Wordで以下の問題が発生していたが、 %APPDATA%\Microsoft\Templates\Normal.dotm を削除して新規作成すると直った。
 * Word2007でwordsvnをアンインストールすると、ツールバーは削除されるのに、なぜかメニューは削除されないことがある。
 * wordsvn.iniで、以下の設定をしても、なぜかShift+Ctrl+uの割り当てだけが残っている。
{{{
    [ShortcutKey]
    ShortcutKeyOnOff=0
    Registered=0
}}}

オレオレ証明書を付ける方法

 * http://support.microsoft.com/kb/883022/ja#7
   ( http://d.hatena.ne.jp/nekotank/20080527/1211872569 より)

 * やるべきかやらざるべきか。-> オレオレ証明書はマクロのユーザーが安全確認の上自ら付けるべきもの。作成者が付けてはいけない。
 * 手元の2007ではWord起動時にワーニングメッセージは表示されないのだが、セキュリティ設定をゆるゆるにしてしまっているのかな?要確認。
　->特にセキュリティ設定を緩くしているわけでもない。2003と2007ではセキュリティ周りで仕様が異なるのか?

インストーラ

 * アドインを有効にするスクリプト

Word2007
{{{
Set objWD = WScript.CreateObject("Word.Application")
'objWD.Visible = True
objWD.AddIns( _
"C:\Documents and Settings\koki\Application Data\Microsoft\Word\STARTUP\wordsvn.dot" _
).Installed = True
}}}

 * Visible = True は、あってもなくてもアドイン有効無効には関係なさそう。
 * AddIns("path\to\addin").Installed = True で有効、Falseで無効。
    ただし、Trueの場合は最初のWord起動時にはアドインのメニュー、ツールバーが表示されない問題がある。
    Falseでは最初のWord起動でアドインのメニュー、ツールバーが消えている。

Excel2007
{{{
Set objXL = WScript.CreateObject("Excel.Application")
objXL.Visible = True
objXL.AddIns("Excelsvn").Installed = True
}}}

 * Visible = Trueを設定しないと、アドインを有効無効できない。
 * Wordのような、アドインのメニュー、ツールバー表示問題はなさそう。

=============================================================

検討が必要な新規仕様

 * 削除コマンドもあると良い。リポジトリに反映するのにコミットが必要なコマンドなので、初心者には分かりにくいところがあるから。ツールバーは無しで、メニューのみの方が良いかな。英語版リリース後に追加しよう。

 * Revertは必要? うっかり実行してしまうと、ワーキングコピーで行った変更すべて失われるので、あまり初心者向きではない。いったんコミットして前のバージョンへ戻すのが一番安全だと思う。

 * PowerPoint対応。でも、PowerPoint97しか持って無いので、他のバージョンでも動くかどうか確認できない。

 * 共有しないファイルは、~~更新、ロック取得、~~コミット~~など~~のときに、いちいち閉じたくは無い。

 * AutoLock機能。共有しているファイルに対して編集をしようとしたら、ロック取得するかどうかを聞いてくれる機能(Visual Studio + Visual Source Safeのように)。

 * AutoAdd機能。特定の作業コピーフォルダへ保存すると、追加+コミットするかどうかを聞いてくれる機能(Visual Studio + Visual Source Safeのように)。

 * ロックモニタ。他人にロックされていたら、リポジトリのロック状況を監視してロックが開放されたら知らせて欲しい。[http://tools.tortoisesvn.net/CommitMonitorDownload Commit Monitor] というソフトはあるが、ロックの状況までは監視してくれないみたい。作者に要望を出したら作ってくれるかな?

(追記)
同様なソフト

 [http://svnnotifier.tigris.org/]

 [http://code.google.com/p/svnnotifier/ Mirror]

 * インストーラも欲しい。

 * svnコマンドバーボタンやメニュー項目のユーザーカスタマイズ機能
 
   - 各ボタン、メニュー項目の表示の有無の設定
   - メニューやボタンの表示位置の設定
   - キャプション、ボタン画像の設定

* TortoiseSVNのdiffツール設定

HKEY_CURRENT_USER\Software\TortoiseSVN

HKEY_CURRENT_USER\Software\TortoiseSVN\DiffTools